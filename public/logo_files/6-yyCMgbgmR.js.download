;/*FB_PKG_DELIM*/

__d("LSCreateOpenToE2EEThreadLink",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[],d=[];return b.sequence([function(d){return b.sequence([function(c){return b.db.table(193).put({openThreadId:a[0],armadilloThreadId:a[1],showOpenMessageHistory:a[2],timestampMs:a[3]})},function(a){return c[0]=new b.Map()}])},function(a){return b.resolve(d)}])}a.__sproc_name__="LSE2EEMessagingMetadataMailboxCreateOpenToE2EEThreadLinkStoredProcedure";a.__tables__=["cutover_threads"];e.exports=a}),null);
__d("LSHandleMessageWithProtobufsRestore",["LSArrayGetObjectAt","LSDecryptMessageProtobufs","LSDeserializeFromJsonIntoDictionaryV2.nop","LSIsEncryptionVersionSecure","LSLoadThreadPkFromThreadId","LSLogMebClientEvent.nop","LSLogWebQpl.nop","LSQplAnnotateString.nop","LSQplMarkEnd.nop","LSQplMarkPoint.nop","LSQplStartTrace.nop","LSRestoreProtobufs.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][handleMessageWithProtobufsRestore] Beginning execution."),d[1]=c.i64.of_float(Date.now()),d[2]=new c.Map(),d[3]=new c.Map(),c.storedProcedure(b("LSDecryptMessageProtobufs"),a[0],a[2]).then(function(a){return a=a,d[4]=a[0],d[5]=a[1],a})},function(e){return d[6]=a[5].get("request_id"),d[7]=a[5].get("restore_task_source"),d[8]=c.i64.of_int32(a[0].length),d[6]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[6],c.i64.cast([0,521476165]),"call_from_client",d[8],void 0,void 0):c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplStartTrace.nop"),c.i64.cast([0,679687866]),d[6],!0,void 0):c.resolve()},function(e){return c.i64.neq(a[7],void 0)?c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[22]=new c.Map(),d[22].set("error_msg","Expected a nonempty query result"),d[22].set("code",c.i64.cast([0,3])),d[22].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[23]=c.createArray(),d[24]=(d[23].push(d[22]),d[23]),e=[void 0,d[23]],d[16]=e[0],d[17]=e[1]):(b=a.item,d[22]=new c.Map(),d[22].set("backup_id",b.backupId),d[22].set("device_public_key_blob",b.devicePublicKeyBlob),d[22].set("device_private_key_blob",b.devicePrivateKeyBlob),d[22].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[22].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[22].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[22].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[22].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[22].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[22].set("orf_client_state_v2_blob",void 0),d[22].set("orf_v2_authority_level",void 0),d[22].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[22].set("device_id",b.deviceId),d[22].set("backup_tenancy",b.backupTenancy),d[22].set("encryption_version",b.encryptionVersion),d[22].set("revision_version",b.revisionVersion),d[22].set("initialize_restore_result",void 0),d[22].set("device_creation_timestamp_sec",void 0),d[22].set("authority_level",b.authorityLevel),e=[d[22],void 0],d[16]=e[0],d[17]=e[1])})},function(e){return d[19]=new c.Map(),d[19].set("value",d[16]),d[19].set("errors",d[17]),d[20]=d[19].get("value"),d[20]!==void 0?c.sequence([function(e){return d[22]=d[20].get("backup_id"),d[23]=d[20].get("device_public_key_blob"),d[24]=d[20].get("device_private_key_blob"),d[25]=d[20].get("epoch_storage_public_key_blob"),d[26]=d[20].get("epoch_storage_private_key_blob"),d[27]=d[20].get("epoch_auth_public_key_blob"),d[28]=d[20].get("epoch_auth_private_key_blob"),d[29]=d[20].get("mailbox_root_key_blob"),d[30]=d[20].get("ocmf_client_state_blob"),d[31]=d[20].get("orf_client_state_v2_blob"),d[32]=d[20].get("orf_v2_authority_level"),d[33]=d[20].get("oblivious_validation_token_blob"),d[34]=d[20].get("device_id"),d[35]=d[20].get("backup_tenancy"),d[36]=d[20].get("encryption_version"),d[37]=d[20].get("revision_version"),d[38]=d[20].get("initialize_restore_result"),d[39]=d[20].get("device_creation_timestamp_sec"),d[40]=d[20].get("authority_level"),c.i64.neq(d[34],void 0)?c.sequence([function(a){return d[42]=void 0,c.i64.neq(d[42],void 0)?c.resolve(d[43]=d[42]):c.sequence([function(a){return d[46]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[56]=(d[46].push(c.i64.cast([0,0])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[56]=(d[46].push(c.i64.cast([0,2])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[56]=(d[46].push(c.i64.cast([0,3])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[56]=(d[46].push(c.i64.cast([0,4])),d[46]):0,d[51]=c.createArray(),d[52]=c.i64.of_int32(d[46].length),c.i64.gt(d[52],c.i64.cast([0,0]))?c.loopAsync(d[52],function(a){return d[56]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[56]).then(function(a){return a=a,d[57]=a[0],d[58]=a[1],a})},function(a){return d[59]=(d[51].push(d[57]),d[51])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[56]=c.createArray(),d[57]=c.i64.of_int32(d[51].length),c.i64.gt(d[57],c.i64.cast([0,0]))?c.loopAsync(d[57],function(a){return d[59]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[51],d[59]).then(function(a){return a=a,d[60]=a[0],d[61]=a[1],a})},function(a){return d[62]=(d[56].push(c.i64.to_string(d[60])),d[56])}])}):c.resolve()},function(a){return d[58]=d[56].join(","),d[53]=d[58]}])},function(a){return d[51].some(function(a){return c.i64.eq(d[36],a)})?d[54]=d[36]:d[54]=void 0,c.i64.neq(d[54],void 0)?d[55]=d[54]:d[55]=void 0,d[43]=d[55]}])},function(b){return c.i64.neq(d[43],void 0)?d[44]=d[43]:d[44]=c.i64.cast([0,0]),c.i64.neq(d[35],void 0)?d[45]=d[35]:d[45]=c.i64.cast([0,1]),d[41]=c.i64.neq(d[34],a[7])}]):c.resolve(d[41]=!1)},function(a){return d[21]=d[41]}]):c.resolve((d[22]=d[19].get("errors"),d[23]=d[19].get("errors"),d[21]=!1))},function(a){return d[9]=d[21]}]):c.resolve(d[9]=!1)},function(e){return d[9]?c.sequence([function(e){return d[16]=new c.Map(),d[16].set("error_code",c.i64.cast([0,110])),d[16].set("stored_procedure","LSEncryptedBackupsHandleMessageWithProtobufsRestoreStoredProcedure"),d[16].set("error_message",""),c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[17]=a[0],d[18]=a[1],a})},function(a){return d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,110])),d[19].set("stored_procedure","LSEncryptedBackupsHandleMessageWithProtobufsRestoreStoredProcedure"),d[19].set("error_message",""),d[6]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679677570]),d[6],"handle_restore_response"):c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679677570]),d[6],!1):c.resolve()},function(a){return d[19]!==void 0?(d[22]=d[19].get("error_code"),d[20]=["LSEBPayloadSerializerError","_",c.i64.to_string(d[22])].join("")):d[20]="unknown_failure",d[21]=["LSEncryptedBackupsHandleMessageWithProtobufsRestoreStoredProcedure",".",d[20]].join(""),d[6]!==void 0?d[21]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),d[6],"error",d[21]):c.resolve():c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679687866]),d[6],!1):c.resolve()}]):c.sequence([function(e){return d[4]!==void 0?c.sequence([function(e){return c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[18]=a[0],d[19]=a[1],a})},function(e){return c.i64.neq(d[18],void 0)?c.sequence([function(e){return void 0!==void 0?c.resolve((d[24]=c.createArray(),e=[d[24],void 0],d[22]=e[0],d[23]=e[1])):c.sequence([function(e){return d[24]=a[1].get("has_more_before"),d[25]=a[1].get("has_more_after"),d[24]?(d[34]=a[1].get("next_message_timestamp_ms_before"),d[26]=d[34]):d[26]=void 0,d[25]?(d[34]=a[1].get("next_message_timestamp_ms_after"),d[27]=d[34]):d[27]=void 0,d[28]=a[1].get("has_more_before"),d[29]=a[1].get("has_more_after"),d[30]=a[5].get("request_id"),d[31]=a[5].get("reference_timestamp"),d[32]=c.createArray(),c.nativeOperation(b("LSRestoreProtobufs.nop"),a[2],d[4],d[28],d[26],d[29],d[27],a[4],d[30],d[31],a[6],d[32],d[7],void 0)},function(a){return void 0!==void 0?d[33]=void 0:(d[34]=c.createArray(),d[33]=d[34]),a=[d[33],void 0],d[22]=a[0],d[23]=a[1]}])},function(a){return a=[d[22],d[23]],d[20]=a[0],d[21]=a[1],a}]):c.resolve((d[22]=c.createArray(),e=[d[22],d[19]],d[20]=e[0],d[21]=e[1]))},function(a){return a=[d[20],d[21]],d[16]=a[0],d[17]=a[1],a}]):c.resolve((d[5]!==void 0?(d[19]=d[5].get("error_code"),c.i64.eq(d[19],c.i64.cast([0,1]))?0:0):0,d[18]=c.createArray(),e=[d[18],d[5]],d[16]=e[0],d[17]=e[1]))},function(e){return d[17]!==void 0?c.sequence([function(e){return c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[18]=a[0],d[19]=a[1],a})},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679677570]),d[6],"handle_restore_response"):c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679677570]),d[6],!1):c.resolve()},function(a){return d[17]!==void 0?(d[22]=d[17].get("error_code"),d[20]=["LSEBPayloadSerializerError","_",c.i64.to_string(d[22])].join("")):d[20]="unknown_failure",d[21]=["LSEncryptedBackupsHandleMessageWithProtobufsRestoreStoredProcedure",".",d[20]].join(""),d[6]!==void 0?d[21]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),d[6],"error",d[21]):c.resolve():c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679687866]),d[6],!1):c.resolve()},function(e){return a[6]!==void 0?c.sequence([function(b){return d[22]=a[5].get("request_id"),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[53]=new c.Map(),d[53].set("error_msg","Expected a nonempty query result"),d[53].set("code",c.i64.cast([0,3])),d[53].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[54]=c.createArray(),d[55]=(d[54].push(d[53]),d[54]),e=[void 0,d[54]],d[23]=e[0],d[24]=e[1]):(b=a.item,d[53]=new c.Map(),d[53].set("backup_id",b.backupId),d[53].set("device_public_key_blob",b.devicePublicKeyBlob),d[53].set("device_private_key_blob",b.devicePrivateKeyBlob),d[53].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[53].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[53].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[53].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[53].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[53].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[53].set("orf_client_state_v2_blob",void 0),d[53].set("orf_v2_authority_level",void 0),d[53].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[53].set("device_id",b.deviceId),d[53].set("backup_tenancy",b.backupTenancy),d[53].set("encryption_version",b.encryptionVersion),d[53].set("revision_version",b.revisionVersion),d[53].set("initialize_restore_result",void 0),d[53].set("device_creation_timestamp_sec",void 0),d[53].set("authority_level",b.authorityLevel),e=[d[53],void 0],d[23]=e[0],d[24]=e[1])})},function(a){return d[26]=new c.Map(),d[26].set("value",d[23]),d[26].set("errors",d[24]),d[27]=d[26].get("value"),d[27]!==void 0?c.sequence([function(a){return d[53]=d[27].get("backup_id"),d[54]=d[27].get("device_public_key_blob"),d[55]=d[27].get("device_private_key_blob"),d[56]=d[27].get("epoch_storage_public_key_blob"),d[57]=d[27].get("epoch_storage_private_key_blob"),d[58]=d[27].get("epoch_auth_public_key_blob"),d[59]=d[27].get("epoch_auth_private_key_blob"),d[60]=d[27].get("mailbox_root_key_blob"),d[61]=d[27].get("ocmf_client_state_blob"),d[62]=d[27].get("orf_client_state_v2_blob"),d[63]=d[27].get("orf_v2_authority_level"),d[64]=d[27].get("oblivious_validation_token_blob"),d[65]=d[27].get("device_id"),d[66]=d[27].get("backup_tenancy"),d[67]=d[27].get("encryption_version"),d[68]=d[27].get("revision_version"),d[69]=d[27].get("initialize_restore_result"),d[70]=d[27].get("device_creation_timestamp_sec"),d[71]=d[27].get("authority_level"),c.i64.neq(d[65],void 0)?c.sequence([function(a){return d[73]=void 0,c.i64.neq(d[73],void 0)?c.resolve(d[74]=d[73]):c.sequence([function(a){return d[77]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[78]=a[0],a})},function(a){return d[78]?d[87]=(d[77].push(c.i64.cast([0,0])),d[77]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[79]=a[0],a})},function(a){return d[79]?d[87]=(d[77].push(c.i64.cast([0,2])),d[77]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[80]=a[0],a})},function(a){return d[80]?d[87]=(d[77].push(c.i64.cast([0,3])),d[77]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[81]?d[87]=(d[77].push(c.i64.cast([0,4])),d[77]):0,d[82]=c.createArray(),d[83]=c.i64.of_int32(d[77].length),c.i64.gt(d[83],c.i64.cast([0,0]))?c.loopAsync(d[83],function(a){return d[87]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[77],d[87]).then(function(a){return a=a,d[88]=a[0],d[89]=a[1],a})},function(a){return d[90]=(d[82].push(d[88]),d[82])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[87]=c.createArray(),d[88]=c.i64.of_int32(d[82].length),c.i64.gt(d[88],c.i64.cast([0,0]))?c.loopAsync(d[88],function(a){return d[90]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[82],d[90]).then(function(a){return a=a,d[91]=a[0],d[92]=a[1],a})},function(a){return d[93]=(d[87].push(c.i64.to_string(d[91])),d[87])}])}):c.resolve()},function(a){return d[89]=d[87].join(","),d[84]=d[89]}])},function(a){return d[82].some(function(a){return c.i64.eq(d[67],a)})?d[85]=d[67]:d[85]=void 0,c.i64.neq(d[85],void 0)?d[86]=d[85]:d[86]=void 0,d[74]=d[86]}])},function(a){return c.i64.neq(d[74],void 0)?d[75]=d[74]:d[75]=c.i64.cast([0,0]),c.i64.neq(d[66],void 0)?d[76]=d[66]:d[76]=c.i64.cast([0,1]),d[72]=d[65]}]):c.resolve(d[72]=void 0)},function(a){return d[28]=d[72]}]):c.resolve((d[53]=d[26].get("errors"),d[54]=d[26].get("errors"),d[28]=void 0))},function(e){return d[29]=a[5].get("restore_task_source"),c.nativeOperation(b("LSDeserializeFromJsonIntoDictionaryV2.nop"),a[6]).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[31]=new c.Map(),d[48]="ctx",d[32]=d[30].get(d[48]),d[32]?d[33]=!1:d[33]=!0,d[33]?0:(d[53]=new c.Map(),d[56]="caller",d[54]=d[32].get(d[56]),d[54]!==void 0?d[53].set(d[56],d[54]):0,d[57]="caller_reference_id",d[55]=d[32].get(d[57]),d[55]!==void 0?d[53].set(d[57],d[55]):0,d[31].set(d[48],d[53])),d[49]="query",d[34]=d[30].get(d[49]),d[34]?d[35]=!1:d[35]=!0,d[35]?c.resolve():c.sequence([function(a){return d[53]=d[34].get("__typename"),d[53]==="MPSMessageRangeQuery"?c.resolve((d[55]=new c.Map(),d[61]="thread_id",d[56]=d[34].get(d[61]),d[56]!==void 0?d[55].set(d[61],d[56]):0,d[62]="direction",d[57]=d[34].get(d[62]),d[57]!==void 0?d[55].set(d[62],d[57]):0,d[63]="reference_timestamp",d[58]=d[34].get(d[63]),d[58]!==void 0?(d[58]!==void 0?d[66]=c.i64.from_string(d[58]):d[66]=void 0,d[55].set(d[63],d[66])):0,d[64]="num_messages",d[59]=d[34].get(d[64]),c.i64.neq(d[59],void 0)?d[55].set(d[64],d[59]):0,d[65]="exclude_message_at_reference_time",d[60]=d[34].get(d[65]),d[60]!==void 0?d[55].set(d[65],d[60]):0,d[54]=d[55])):c.sequence([function(a){return d[53]==="MPSMessagePointQuery"?c.sequence([function(a){return d[56]=new c.Map(),d[61]="thread_id",d[57]=d[34].get(d[61]),d[57]!==void 0?d[56].set(d[61],d[57]):0,d[62]="otids",d[58]=d[34].get(d[62]),d[58]?d[59]=!1:d[59]=!0,d[59]?c.resolve():c.sequence([function(a){return d[64]=c.createArray(),d[65]=c.i64.of_int32(d[58].length),c.i64.gt(d[65],c.i64.cast([0,0]))?c.loopAsync(d[65],function(a){return d[66]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[58],d[66]).then(function(a){return a=a,d[67]=a[0],d[68]=a[1],a})},function(a){return d[69]=(d[64].push(d[67]),d[64])}])}):c.resolve()},function(a){return d[56].set(d[62],d[64])}])},function(a){return d[63]="include_deleted",d[60]=d[34].get(d[63]),d[60]!==void 0?d[56].set(d[63],d[60]):0,d[55]=d[56]}]):c.sequence([function(a){return d[53]==="MPSMessageSurroundingQuery"?c.resolve((d[57]=new c.Map(),d[62]="thread_id",d[58]=d[34].get(d[62]),d[58]!==void 0?d[57].set(d[62],d[58]):0,d[63]="reference_timestamp",d[59]=d[34].get(d[63]),d[59]!==void 0?d[57].set(d[63],c.i64.from_string(d[59])):0,d[64]="num_before_messages",d[60]=d[34].get(d[64]),c.i64.neq(d[60],void 0)?d[57].set(d[64],d[60]):0,d[65]="num_after_messages",d[61]=d[34].get(d[65]),c.i64.neq(d[61],void 0)?d[57].set(d[65],d[61]):0,d[56]=d[57])):c.sequence([function(a){return d[53]==="MPSTaggedRangeQuery"?c.sequence([function(a){return d[58]=new c.Map(),d[65]="thread_id",d[59]=d[34].get(d[65]),d[59]!==void 0?d[58].set(d[65],d[59]):0,d[66]="direction",d[60]=d[34].get(d[66]),d[60]!==void 0?d[58].set(d[66],d[60]):0,d[67]="message_tags",d[61]=d[34].get(d[67]),d[61]?d[62]=!1:d[62]=!0,d[62]?c.resolve():c.sequence([function(a){return d[70]=c.createArray(),d[71]=c.i64.of_int32(d[61].length),c.i64.gt(d[71],c.i64.cast([0,0]))?c.loopAsync(d[71],function(a){return d[72]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[61],d[72]).then(function(a){return a=a,d[73]=a[0],d[74]=a[1],a})},function(a){return d[75]=(d[70].push(d[73]),d[70])}])}):c.resolve()},function(a){return d[58].set(d[67],d[70])}])},function(a){return d[68]="reference_timestamp",d[63]=d[34].get(d[68]),d[63]!==void 0?(d[63]!==void 0?d[70]=c.i64.from_string(d[63]):d[70]=void 0,d[58].set(d[68],d[70])):0,d[69]="num_messages",d[64]=d[34].get(d[69]),c.i64.neq(d[64],void 0)?d[58].set(d[69],d[64]):0,d[57]=d[58]}]):c.sequence([function(a){return d[58]=new c.Map(),d[59]=d[34].keys(),d[60]=c.i64.of_int32(d[59].length),c.i64.gt(d[60],c.i64.cast([0,0]))?c.loopAsync(d[60],function(a){return d[61]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[59],d[61]).then(function(a){return a=a,d[62]=a[0],d[63]=a[1],a})},function(a){return d[64]=d[34].get(d[62]),d[58].set(d[62],d[64])}])}):c.resolve()},function(a){return d[57]=d[58]}])},function(a){return d[56]=d[57]}])},function(a){return d[55]=d[56]}])},function(a){return d[54]=d[55]}])},function(a){return d[54].set("__typename",d[53]),d[31].set(d[49],d[54])}])},function(a){return d[36]=d[31].get("query"),d[37]=d[36].get("__typename"),d[37]==="MPSMessagePointQuery"?c.sequence([function(a){return d[53]=d[36].get("__typename"),d[53]==="MPSMessagePointQuery"?c.sequence([function(a){return d[57]=new c.Map(),d[62]="thread_id",d[58]=d[36].get(d[62]),d[58]!==void 0?d[57].set(d[62],d[58]):0,d[63]="otids",d[59]=d[36].get(d[63]),d[59]?d[60]=!1:d[60]=!0,d[60]?c.resolve():c.sequence([function(a){return d[65]=c.createArray(),d[66]=c.i64.of_int32(d[59].length),c.i64.gt(d[66],c.i64.cast([0,0]))?c.loopAsync(d[66],function(a){return d[67]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[59],d[67]).then(function(a){return a=a,d[68]=a[0],d[69]=a[1],a})},function(a){return d[70]=(d[65].push(d[68]),d[65])}])}):c.resolve()},function(a){return d[57].set(d[63],d[65])}])},function(a){return d[64]="include_deleted",d[61]=d[36].get(d[64]),d[61]!==void 0?d[57].set(d[64],d[61]):0,d[54]=d[57]}]):c.resolve(d[54]=void 0)},function(a){return d[54]?d[55]=!1:d[55]=!0,d[55]?c.resolve(d[56]=void 0):c.sequence([function(a){return d[57]=d[54].get("otids"),c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[57],c.i64.cast([0,0])).then(function(a){return a=a,d[58]=a[0],d[59]=a[1],a})},function(a){return d[56]=d[58]}])},function(a){return d[6]!==void 0?d[56]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),d[6],"message_id",d[56]):c.resolve():c.resolve()},function(a){return d[38]="POINT_QUERY_RESTORE"}]):c.resolve((d[53]=d[36].get("__typename"),d[53]==="MPSMessageRangeQuery"?d[54]="RANGE_QUERY_RESTORE":(d[55]=d[36].get("__typename"),d[55]==="MPSMessageSurroundingQuery"?d[56]="SURROUNDING_RESTORE":(d[57]=d[36].get("__typename"),d[57]==="MPSTaggedRangeQuery"?d[58]="TAGGED_RANGE_QUERY_RESTORE":d[58]="unknown_query_type",d[56]=d[58]),d[54]=d[56]),d[38]=d[54]))},function(a){return d[6]!==void 0?d[38]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),d[6],"restore_type",d[38]):c.resolve():c.resolve()},function(e){return d[6]!==void 0?a[2]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),d[6],"act_thread_id",a[2]):c.resolve():c.resolve()},function(a){return d[6]!==void 0?d[22]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),d[6],"request_id",d[22]):c.resolve():c.resolve()},function(a){return d[50]=c.i64.to_string(d[28]),d[6]!==void 0?d[50]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),d[6],"device_id",d[50]):c.resolve():c.resolve()},function(a){return d[51]=c.i64.to_string(d[29]),d[6]!==void 0?d[51]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),d[6],"task_creation_source",d[51]):c.resolve():c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679677570]),d[6],"handle_restore_response"):c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679677570]),d[6],!1):c.resolve()},function(a){return d[17]!==void 0?(d[53]=d[17].get("error_code"),d[39]=["LSEBPayloadSerializerError","_",c.i64.to_string(d[53])].join("")):d[39]="unknown_failure",d[52]=["LSEncryptedBackupsHandleMessageWithProtobufsRestoreStoredProcedure",".",d[39]].join(""),d[6]!==void 0?d[52]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),d[6],"error",d[52]):c.resolve():c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679687866]),d[6],!1):c.resolve()},function(b){return d[40]=a[5].get("request_id"),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[53]=new c.Map(),d[53].set("error_msg","Expected a nonempty query result"),d[53].set("code",c.i64.cast([0,3])),d[53].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[54]=c.createArray(),d[55]=(d[54].push(d[53]),d[54]),e=[void 0,d[54]],d[41]=e[0],d[42]=e[1]):(b=a.item,d[53]=new c.Map(),d[53].set("backup_id",b.backupId),d[53].set("device_public_key_blob",b.devicePublicKeyBlob),d[53].set("device_private_key_blob",b.devicePrivateKeyBlob),d[53].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[53].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[53].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[53].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[53].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[53].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[53].set("orf_client_state_v2_blob",void 0),d[53].set("orf_v2_authority_level",void 0),d[53].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[53].set("device_id",b.deviceId),d[53].set("backup_tenancy",b.backupTenancy),d[53].set("encryption_version",b.encryptionVersion),d[53].set("revision_version",b.revisionVersion),d[53].set("initialize_restore_result",void 0),d[53].set("device_creation_timestamp_sec",void 0),d[53].set("authority_level",b.authorityLevel),e=[d[53],void 0],d[41]=e[0],d[42]=e[1])})},function(a){return d[44]=new c.Map(),d[44].set("value",d[41]),d[44].set("errors",d[42]),d[45]=d[44].get("value"),d[45]!==void 0?c.sequence([function(a){return d[53]=d[45].get("backup_id"),d[54]=d[45].get("device_public_key_blob"),d[55]=d[45].get("device_private_key_blob"),d[56]=d[45].get("epoch_storage_public_key_blob"),d[57]=d[45].get("epoch_storage_private_key_blob"),d[58]=d[45].get("epoch_auth_public_key_blob"),d[59]=d[45].get("epoch_auth_private_key_blob"),d[60]=d[45].get("mailbox_root_key_blob"),d[61]=d[45].get("ocmf_client_state_blob"),d[62]=d[45].get("orf_client_state_v2_blob"),d[63]=d[45].get("orf_v2_authority_level"),d[64]=d[45].get("oblivious_validation_token_blob"),d[65]=d[45].get("device_id"),d[66]=d[45].get("backup_tenancy"),d[67]=d[45].get("encryption_version"),d[68]=d[45].get("revision_version"),d[69]=d[45].get("initialize_restore_result"),d[70]=d[45].get("device_creation_timestamp_sec"),d[71]=d[45].get("authority_level"),c.i64.neq(d[65],void 0)?c.sequence([function(a){return d[73]=void 0,c.i64.neq(d[73],void 0)?c.resolve(d[74]=d[73]):c.sequence([function(a){return d[77]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[78]=a[0],a})},function(a){return d[78]?d[87]=(d[77].push(c.i64.cast([0,0])),d[77]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[79]=a[0],a})},function(a){return d[79]?d[87]=(d[77].push(c.i64.cast([0,2])),d[77]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[80]=a[0],a})},function(a){return d[80]?d[87]=(d[77].push(c.i64.cast([0,3])),d[77]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[81]?d[87]=(d[77].push(c.i64.cast([0,4])),d[77]):0,d[82]=c.createArray(),d[83]=c.i64.of_int32(d[77].length),c.i64.gt(d[83],c.i64.cast([0,0]))?c.loopAsync(d[83],function(a){return d[87]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[77],d[87]).then(function(a){return a=a,d[88]=a[0],d[89]=a[1],a})},function(a){return d[90]=(d[82].push(d[88]),d[82])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[87]=c.createArray(),d[88]=c.i64.of_int32(d[82].length),c.i64.gt(d[88],c.i64.cast([0,0]))?c.loopAsync(d[88],function(a){return d[90]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[82],d[90]).then(function(a){return a=a,d[91]=a[0],d[92]=a[1],a})},function(a){return d[93]=(d[87].push(c.i64.to_string(d[91])),d[87])}])}):c.resolve()},function(a){return d[89]=d[87].join(","),d[84]=d[89]}])},function(a){return d[82].some(function(a){return c.i64.eq(d[67],a)})?d[85]=d[67]:d[85]=void 0,c.i64.neq(d[85],void 0)?d[86]=d[85]:d[86]=void 0,d[74]=d[86]}])},function(a){return c.i64.neq(d[74],void 0)?d[75]=d[74]:d[75]=c.i64.cast([0,0]),c.i64.neq(d[66],void 0)?d[76]=d[66]:d[76]=c.i64.cast([0,1]),d[72]=d[65]}]):c.resolve(d[72]=void 0)},function(a){return d[46]=d[72]}]):c.resolve((d[53]=d[44].get("errors"),d[54]=d[44].get("errors"),d[46]=void 0))},function(b){return d[47]=a[5].get("restore_task_source")}]):c.resolve()}]):c.sequence([function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679677570]),d[6],"handle_restore_response"):c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679677570]),d[6],!0):c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),d[6],"handle_restore_response"):c.resolve()},function(a){return d[6]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679687866]),d[6],!0):c.resolve()},function(b){return d[18]=a[5].get("restore_task_source"),c.i64.eq(d[18],c.i64.cast([0,58]))?0:0}])}])},function(a){return d[10]=c.i64.of_float(Date.now()),d[11]=c.i64.random(),d[13]="Finishing execution. Execution time: ",d[14]=c.i64.to_string(c.i64.sub(d[10],d[0])),d[15]=" ms",d[12]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageWithProtobufsRestore] ",d[12],d[13],d[12],d[14],d[12],d[15]].join("")),c.i64.eq(c.i64.mod_(d[11],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[16]=",",d[17]=c.createArray(),void 0!==void 0?d[18]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageWithProtobufsRestore",[d[13],d[16],d[14],d[16],d[15]].join(""),d[17],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleMessageWithProtobufsRestoreStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSIssueCheckBackupStateOnInitSyncTask",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[6]=new c.Map(),d[6].set("error_msg","Expected a nonempty query result"),d[6].set("code",c.i64.cast([0,3])),d[6].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[7]=c.createArray(),d[8]=(d[7].push(d[6]),d[7]),e=[void 0,d[7]],d[0]=e[0],d[1]=e[1]):(b=a.item,d[6]=new c.Map(),d[6].set("backup_id",b.backupId),d[6].set("device_public_key_blob",b.devicePublicKeyBlob),d[6].set("device_private_key_blob",b.devicePrivateKeyBlob),d[6].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[6].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[6].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[6].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[6].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[6].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[6].set("orf_client_state_v2_blob",void 0),d[6].set("orf_v2_authority_level",void 0),d[6].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[6].set("device_id",b.deviceId),d[6].set("backup_tenancy",b.backupTenancy),d[6].set("encryption_version",b.encryptionVersion),d[6].set("revision_version",b.revisionVersion),d[6].set("initialize_restore_result",void 0),d[6].set("device_creation_timestamp_sec",void 0),d[6].set("authority_level",b.authorityLevel),e=[d[6],void 0],d[0]=e[0],d[1]=e[1])})},function(a){return d[3]=new c.Map(),d[3].set("value",d[0]),d[3].set("errors",d[1]),d[4]=d[3].get("value"),d[4]!==void 0?c.sequence([function(a){return d[6]=d[4].get("backup_id"),d[7]=d[4].get("device_public_key_blob"),d[8]=d[4].get("device_private_key_blob"),d[9]=d[4].get("epoch_storage_public_key_blob"),d[10]=d[4].get("epoch_storage_private_key_blob"),d[11]=d[4].get("epoch_auth_public_key_blob"),d[12]=d[4].get("epoch_auth_private_key_blob"),d[13]=d[4].get("mailbox_root_key_blob"),d[14]=d[4].get("ocmf_client_state_blob"),d[15]=d[4].get("orf_client_state_v2_blob"),d[16]=d[4].get("orf_v2_authority_level"),d[17]=d[4].get("oblivious_validation_token_blob"),d[18]=d[4].get("device_id"),d[19]=d[4].get("backup_tenancy"),d[20]=d[4].get("encryption_version"),d[21]=d[4].get("revision_version"),d[22]=d[4].get("initialize_restore_result"),d[23]=d[4].get("device_creation_timestamp_sec"),d[24]=d[4].get("authority_level"),c.i64.neq(d[18],void 0)?c.sequence([function(a){return d[26]=void 0,c.i64.neq(d[26],void 0)?c.resolve(d[27]=d[26]):c.sequence([function(a){return d[33]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[43]=(d[33].push(c.i64.cast([0,0])),d[33]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[35]=a[0],a})},function(a){return d[35]?d[43]=(d[33].push(c.i64.cast([0,2])),d[33]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[36]=a[0],a})},function(a){return d[36]?d[43]=(d[33].push(c.i64.cast([0,3])),d[33]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[37]=a[0],a})},function(a){return d[37]?d[43]=(d[33].push(c.i64.cast([0,4])),d[33]):0,d[38]=c.createArray(),d[39]=c.i64.of_int32(d[33].length),c.i64.gt(d[39],c.i64.cast([0,0]))?c.loopAsync(d[39],function(a){return d[43]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[33],d[43]).then(function(a){return a=a,d[44]=a[0],d[45]=a[1],a})},function(a){return d[46]=(d[38].push(d[44]),d[38])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[43]=c.createArray(),d[44]=c.i64.of_int32(d[38].length),c.i64.gt(d[44],c.i64.cast([0,0]))?c.loopAsync(d[44],function(a){return d[46]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[38],d[46]).then(function(a){return a=a,d[47]=a[0],d[48]=a[1],a})},function(a){return d[49]=(d[43].push(c.i64.to_string(d[47])),d[43])}])}):c.resolve()},function(a){return d[45]=d[43].join(","),d[40]=d[45]}])},function(a){return d[38].some(function(a){return c.i64.eq(d[20],a)})?d[41]=d[20]:d[41]=void 0,c.i64.neq(d[41],void 0)?d[42]=d[41]:d[42]=void 0,d[27]=d[42]}])},function(a){return c.i64.neq(d[27],void 0)?d[28]=d[27]:d[28]=c.i64.cast([0,0]),c.i64.neq(d[19],void 0)?d[29]=d[19]:d[29]=c.i64.cast([0,1]),d[30]=new c.Map(),d[30].set("backup_id",d[6]),d[30].set("device_id",d[18]),d[31]=c.toJSON(d[30]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",c.i64.cast([0,50054]),d[31],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[25]=!0}]):c.resolve((function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssueCheckBackupStateOnInitSyncTaskStoredProcedure] No client state in checkBackupStateOnInitSyncTask with reason: 24"),d[25]=!1))},function(a){return d[5]=d[25]}]):c.resolve((d[6]=d[3].get("errors"),d[7]=d[3].get("errors"),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssueCheckBackupStateOnInitSyncTaskStoredProcedure] No client state in checkBackupStateOnInitSyncTask with reason: 1"),d[5]=!1))}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueCheckBackupStateOnInitSyncTaskStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSMoveThreadToE2EECutoverFolder",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(9).fetch([[[a[0]]]]).next().then(function(c,d){d=c.done;c=c.value;return d?0:(c.item,b.forEach(b.db.table(9).fetch([[[a[0]]]]),function(a){var c=a.update;a.item;return c({folderName:"e2ee_cutover",parentThreadKey:b.i64.cast([-1,4294967279])})}))})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSMailboxMoveThreadToE2EECutoverFolderStoredProcedure";a.__tables__=["threads"];e.exports=a}),null);
__d("LSSetHMPSStatus",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.resolve(c)}a.__sproc_name__="LSMailboxSetHMPSStatusStoredProcedure";a.__tables__=[];e.exports=a}),null);
__d("LSShimCopyAllParticipantNicknamesForThread",["gkx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,b=a[a.length-1],d=[];return c("gkx")("26379")===!1?0:0,b.resolve(d)}a.__sproc_name__="LSMailboxShimCopyAllParticipantNicknamesForThreadStoredProcedure";a.__tables__=[];b=a;g["default"]=b}),98);
__d("WABatcher",["Promise","WAResolvable","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,d){var e=a.delayMs,f=a.maxSize,g=null;function i(a){g&&g.args===a&&(g=null);return d(a)}var j=function(){if(g==null)return(h||(h=b("Promise"))).resolve();var a=g;g=null;clearTimeout(a.timer);a.run();return a.batchPromise};a=function(a){if(g)g.args.push(a);else{var d,k=[a];a=new(h||(h=b("Promise")))(function(a){d=function(){return void a(k)}}).then(i);var l=d;g={args:k,batchPromise:a,run:l,timer:setTimeout(l,e)}}if(g==null)throw c("err")("activeBatch should not be null here");a=g;l=a.args;a=a.batchPromise;var m=l.length-1;f!=null&&l.length>=f&&void j();return a.then(function(a){return a[m]})};return{accept:a,runActiveBatch:j}}function a(a,b){var c=i(a,b);return function(a){return c.accept(a)}}function e(a){var e=[],f=new(d("WAResolvable").Resolvable)(),g=function(c){if(e.length===0)return(h||(h=b("Promise"))).resolve(new Map());var g=e,i=f;e=[];f=new(d("WAResolvable").Resolvable)();return(h||(h=b("Promise"))).resolve(a(g,c)).then(function(a){i.resolve(a);return a})},i=function(a){e.push(a);return f.promise.then(function(b){b=b.get(a);if(b==null)throw c("err")("This should not happen because we just added it to the batch");return b})};return{accept:i,runActiveBatch:g}}g.createSimpleBatcher=i;g.batch=a;g.createBatcher=e}),98);
__d("LSShimVerifyThreadExists.nop",["I64","LSPlatformArmadilloUtils","LSPlatformLsInitLog","MAWActThreadMapping","MAWBridgeOccamadilloVerifyThreadExistsHandler","MAWBulkCreateOrUpdateThreadInActWithMiData","MAWJids","MAWMIC","MAWThreadMappingQPL","MAWThreadMappingState","MAWTrackPendingOccamadilloThreads","MWCookieUtil","MWFBLogger","ReQL","WABatcher","WATimeUtils","getErrorSafe","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=d("MWFBLogger").MWLogger.tags(["MiActMapping","ThreadReady","Occam"]),l=new Map(),m=[];d("LSPlatformArmadilloUtils").executeOnThreadMappingEnd(function(){if(m.length===0)return;var a=m.map(function(a){var b=p(a,"LSShimVerifyThreadExists.init_sync");return babelHelpers.extends({instanceKey:b},a)});o(d("MAWBulkCreateOrUpdateThreadInActWithMiData").bulkCreateOrUpdateThreadInActWithMiData(void 0,a,"init_sync"),a.map(function(a){return a.instanceKey}).filter(Boolean),!0)});a=200;b=20;var n=d("WABatcher").createSimpleBatcher({delayMs:a,maxSize:b},function(a){a=a.map(function(a){var b=p(a,"LSShimVerifyThreadExists.non-init_sync");return babelHelpers.extends({instanceKey:b},a)});o(d("MAWBulkCreateOrUpdateThreadInActWithMiData").bulkCreateOrUpdateThreadInActWithMiData(void 0,a,"batched_mapping"),a.map(function(a){return a.instanceKey}).filter(Boolean),!1);return[]});e=async function(a,b,e,f,g,q,r,s,t,u,v,w,x){d("MAWTrackPendingOccamadilloThreads").markThreadPassedToNativeOp({callingSource:x});b=d("MAWThreadMappingQPL").pendingThreadCreationOnServer.get((j||(j=d("I64"))).to_string(f));g=await Promise.all([d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.threads).getKeyRange(e)),d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.mi_act_mapping_table).getKeyRange(e))]);q=g[0];u=g[1];v=d("MAWJids").convertIntJidToChatJid(f,r);if(c("gkx")("11539")){w=d("MAWThreadMappingState").getMappingStateForDbRows(q,u);d("MAWThreadMappingState").isActReady(w)&&d("MAWActThreadMapping").executePromisesBlockedOnActThreadMapping({authoritativeThreadKey:(j||(j=d("I64"))).to_string(e),description:"LSShimVerifyThreadExists",instanceKey:b,jid:v,optimisticThreadKey:null});q!=null&&d("MAWThreadMappingState").isReady(w)&&await d("MAWBridgeOccamadilloVerifyThreadExistsHandler").genUpdatesForAuthoritativeThread(a,q.threadKey,{clientThreadKey:q.clientThreadKey!=null?(j||(j=d("I64"))).to_string(q.clientThreadKey):null,instanceKey:b,isGroup:r,lastActivityTs:d("WATimeUtils").castToMillisTime((j||(j=d("I64"))).to_float(q.lastActivityTimestampMs))})}x=b!=null?b:d("MAWThreadMappingQPL").getInstanceKeyForThreadKey(e);l.set(x,{hasMappingRowAlready:u!=null,isExistingRowPlaceholder:u==null?void 0:(j||(j=d("I64"))).to_float(u.clientThreadPk)<0,isExpectedThreadMissingInLsdb:q==null});u==null&&await d("MAWThreadMappingState").markActThreadMappingAsInProgress(a,e,f);k.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Insert MI thread: fbid:",", jid:",", last activity ts:",", last read ts:",", read=",""])),j.to_string(e),j.to_string(f),j.to_string(s),j.to_string(t),String(j.le(s,t)));(j||(j=d("I64"))).equal(s,(j||(j=d("I64"))).zero)&&k.WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["MI thread insertion with lastActivityTimestamp == 0 for lastReadWatermarkTimestampMs: ",""])),(j||(j=d("I64"))).to_string(t));d("MAWTrackPendingOccamadilloThreads").addPendingThread(v);g={description:"LSShimVerifyThreadExists.nop",fbid:e,forceLoadMessages:d("MWCookieUtil").isInChatHead(e),instanceKey:x,isGroupThread:r,jid:f,lastActivityTimestampMs:s,lastReadWatermarkTimestampMs:t};w=d("MWCookieUtil").isAutoChatTabFromCookie(e);w?(p(g,"LSShimVerifyThreadExists.acto"),o(d("MAWBulkCreateOrUpdateThreadInActWithMiData").bulkCreateOrUpdateThreadInActWithMiData(void 0,[g],"acto"),[x],!0)):d("LSPlatformLsInitLog").LsSync.isRunning()?m.push(g):c("promiseDone")(n.accept(g))};f=e;function o(a,b,e){a.catch(function(a){e&&d("MAWMIC").fail("thread_mapping_error",c("getErrorSafe")(a));b.forEach(function(b){return d("MAWThreadMappingQPL").endFailureError(a,b)});return a})}function p(a,b){var c=a.instanceKey!=null?l.get(a.instanceKey):null;c=c==null?null:{hasMappingRowAlready:c.hasMappingRowAlready,hasPlaceholderRowInserted:!c.hasMappingRowAlready,isExistingRowPlaceholder:c.isExistingRowPlaceholder,isExpectedThreadMissingInLsdb:c.isExpectedThreadMissingInLsdb};return d("MAWThreadMappingQPL").startOrContinueForMiActMappingParams(a,b,c)}e.__nop_name__="LSShimVerifyThreadExists";g.default=f}),98);
__d("LSUpdateOccamadilloMostRecentMessagePerThread",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[],d=[];return b.sequence([function(d){return b.db.table(292).fetch([[[a[0]]]]).next().then(function(d,e){var f=d.done;d=d.value;return f?(c[1]=b.i64.of_float(Date.now()),b.db.table(292).add({threadKey:a[0],timestampMs:a[1],fetchTimestampMs:c[1]})):(e=d.item,c[2]=e.fetchTimestampMs,c[1]=b.i64.of_float(Date.now()),b.i64.neq(c[2],void 0)?b.i64.ge(c[1],b.i64.add(c[2],b.i64.cast([0,2592e6])))?b.db.table(292).put({threadKey:a[0],timestampMs:a[1],fetchTimestampMs:c[1]}):b.resolve():b.forEach(b.db.table(292).fetch([[[a[0]]]]),function(a){var b=a.update;a.item;return b({fetchTimestampMs:c[1]})}))})},function(a){return b.resolve(d)}])}a.__sproc_name__="LSE2EEMessagingMetadataMailboxUpdateOccamadilloMostRecentMessagePerThreadStoredProcedure";a.__tables__=["occamadillo_most_recent_message_per_thread"];e.exports=a}),null);
__d("LSVerifyHybridThreadExists",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSShimVerifyThreadExists.nop","LSVerifyE2EEMetadataThreadExistsV2"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return c.storedProcedure(b("LSVerifyE2EEMetadataThreadExistsV2"),a[2],a[0],c.i64.cast([0,60])).then(function(a){return a=a,d[0]=a[0],a})},function(e){return d[1]=c.i64.of_float(Date.now()),c.i64.neq(a[11],void 0)?c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[10]=new c.Map(),d[10].set("error_msg","Expected a nonempty query result"),d[10].set("code",c.i64.cast([0,3])),d[10].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[11]=c.createArray(),d[12]=(d[11].push(d[10]),d[11]),e=[void 0,d[11]],d[4]=e[0],d[5]=e[1]):(b=a.item,d[10]=new c.Map(),d[10].set("backup_id",b.backupId),d[10].set("device_public_key_blob",b.devicePublicKeyBlob),d[10].set("device_private_key_blob",b.devicePrivateKeyBlob),d[10].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[10].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[10].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[10].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[10].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[10].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[10].set("orf_client_state_v2_blob",void 0),d[10].set("orf_v2_authority_level",void 0),d[10].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[10].set("device_id",b.deviceId),d[10].set("backup_tenancy",b.backupTenancy),d[10].set("encryption_version",b.encryptionVersion),d[10].set("revision_version",b.revisionVersion),d[10].set("initialize_restore_result",void 0),d[10].set("device_creation_timestamp_sec",void 0),d[10].set("authority_level",b.authorityLevel),e=[d[10],void 0],d[4]=e[0],d[5]=e[1])})},function(e){return d[7]=new c.Map(),d[7].set("value",d[4]),d[7].set("errors",d[5]),d[8]=d[7].get("value"),d[8]!==void 0?c.sequence([function(e){return d[10]=d[8].get("backup_id"),d[11]=d[8].get("device_public_key_blob"),d[12]=d[8].get("device_private_key_blob"),d[13]=d[8].get("epoch_storage_public_key_blob"),d[14]=d[8].get("epoch_storage_private_key_blob"),d[15]=d[8].get("epoch_auth_public_key_blob"),d[16]=d[8].get("epoch_auth_private_key_blob"),d[17]=d[8].get("mailbox_root_key_blob"),d[18]=d[8].get("ocmf_client_state_blob"),d[19]=d[8].get("orf_client_state_v2_blob"),d[20]=d[8].get("orf_v2_authority_level"),d[21]=d[8].get("oblivious_validation_token_blob"),d[22]=d[8].get("device_id"),d[23]=d[8].get("backup_tenancy"),d[24]=d[8].get("encryption_version"),d[25]=d[8].get("revision_version"),d[26]=d[8].get("initialize_restore_result"),d[27]=d[8].get("device_creation_timestamp_sec"),d[28]=d[8].get("authority_level"),c.i64.neq(d[22],void 0)?c.sequence([function(a){return d[30]=void 0,c.i64.neq(d[30],void 0)?c.resolve(d[31]=d[30]):c.sequence([function(a){return d[34]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[35]=a[0],a})},function(a){return d[35]?d[44]=(d[34].push(c.i64.cast([0,0])),d[34]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[36]=a[0],a})},function(a){return d[36]?d[44]=(d[34].push(c.i64.cast([0,2])),d[34]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[37]=a[0],a})},function(a){return d[37]?d[44]=(d[34].push(c.i64.cast([0,3])),d[34]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[38]=a[0],a})},function(a){return d[38]?d[44]=(d[34].push(c.i64.cast([0,4])),d[34]):0,d[39]=c.createArray(),d[40]=c.i64.of_int32(d[34].length),c.i64.gt(d[40],c.i64.cast([0,0]))?c.loopAsync(d[40],function(a){return d[44]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[34],d[44]).then(function(a){return a=a,d[45]=a[0],d[46]=a[1],a})},function(a){return d[47]=(d[39].push(d[45]),d[39])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[44]=c.createArray(),d[45]=c.i64.of_int32(d[39].length),c.i64.gt(d[45],c.i64.cast([0,0]))?c.loopAsync(d[45],function(a){return d[47]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[39],d[47]).then(function(a){return a=a,d[48]=a[0],d[49]=a[1],a})},function(a){return d[50]=(d[44].push(c.i64.to_string(d[48])),d[44])}])}):c.resolve()},function(a){return d[46]=d[44].join(","),d[41]=d[46]}])},function(a){return d[39].some(function(a){return c.i64.eq(d[24],a)})?d[42]=d[24]:d[42]=void 0,c.i64.neq(d[42],void 0)?d[43]=d[42]:d[43]=void 0,d[31]=d[43]}])},function(b){return c.i64.neq(d[31],void 0)?d[32]=d[31]:d[32]=c.i64.cast([0,0]),c.i64.neq(d[23],void 0)?d[33]=d[23]:d[33]=c.i64.cast([0,1]),d[29]=c.i64.neq(d[22],a[11])}]):c.resolve(d[29]=!1)},function(a){return d[9]=d[29]}]):c.resolve((d[10]=d[7].get("errors"),d[11]=d[7].get("errors"),d[9]=!1))},function(a){return d[2]=d[9]}]):c.resolve(d[2]=!1)},function(e){return d[2]?d[3]=!0:d[3]=a[8],c.nativeOperation(b("LSShimVerifyThreadExists.nop"),a[0],a[1],a[3],a[4],a[5],a[6],a[7],d[3],a[9],a[10],a[12])},function(a){return e[0]=c.i64.cast([0,0])}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSE2EEMessagingMetadataMailboxVerifyHybridThreadExistsStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);